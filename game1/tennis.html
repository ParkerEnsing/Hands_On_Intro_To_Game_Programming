<!DOCTYPE html>
<html lang="en">
    <head>
        <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
        <meta content="utf-8" http-equiv="encoding">
    </head>

    <body>
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <script>
            var canvas;
            var canvasContext;

            // Ball Parameters
            var ballX, ballY;
            var ballSpeedX, ballSpeedY;
            const BALL_RADIUS = 10;

            // Bumper Parameters
            const BUMPER_WIDTH = 10, BUMPER_HEIGHT = 100;
            const BUMPER_SPACE_X = 10;
            var bumperLeftX, bumperLeftY;
            var bumperRightX, bumperRightY;

            // Center Line Parameters
            const CENTER_LINE_WIDTH = 6;

            // Gameplay Parameters
            var scoreLeft = 0; scoreRight = 0;
            const INITIAL_BALL_SPEED_X = 3, INITIAL_BALL_SPEED_Y = 3;
            const NORMAL_BALL_SPEED_X = 6, NORMAL_BALL_SPEED_Y = 6;
            
            // Loads game in browser
            window.onload = function() {
                // Set canvas properties
                canvas = document.getElementById("gameCanvas");
                canvasContext = canvas.getContext("2d");

                // Initialize the game
                var framesPerSecond = 30;
                resetBall();

                // Determine bumper placement
                bumperLeftX = BUMPER_SPACE_X;
                bumperRightX = canvas.width - BUMPER_SPACE_X - BUMPER_WIDTH;

                // Create mouse event listener for user input
                canvas.addEventListener("mousemove", function(evt) {
                    var mousePos = calculateMousePosition(evt);
                    bumperLeftY = mousePos.y - 0.5 * BUMPER_HEIGHT; // Centers the bumper on mouse Y pos
                    bumperRightY = mousePos.y - 0.5 * BUMPER_HEIGHT; // Centers the bumper on mouse Y pos
                });

                // Per frame calculation
                setInterval(function() {
                    moveEverything();
                    drawEverything();
                }, 0.001 * framesPerSecond);
            }

            // Determines the mouse position
            function calculateMousePosition(evt) {
                var rect = canvas.getBoundingClientRect(), root = document.documentElement;

                mouseX = evt.clientX - rect.left - root.scrollLeft;
                mouseY = evt.clientY - rect.top - root.scrollTop;

                return {
                    x: mouseX,
                    y: mouseY
                };
            }
            
            // Outputs 1 or -1 randomly
            // Used for randomly deciding direction
            function randomPosOrNeg() {
                if (Math.random() < 0.5) {return -1} else {return 1}
            }

            // Places the ball back in the center and gives it a random direction of motion
            function resetBall() {
                ballX = 0.5 * canvas.width;
                ballY = 0.5 * canvas.height;

                ballSpeedX = INITIAL_BALL_SPEED_X;
                ballSpeedY = INITIAL_BALL_SPEED_Y;

                ballSpeedX *= randomPosOrNeg();
                ballSpeedY *= randomPosOrNeg();
            }

            // Keeps the bumpers within the canvas
            function checkBumperPosition(yMin, yMax) {
                if (bumperLeftY < yMin) {
                    bumperLeftY = 0;
                }

                if (bumperLeftY > yMax) {
                    bumperLeftY = yMax;
                }

                if (bumperRightY < yMin) {
                    bumperRightY = 0;
                }

                if (bumperRightY > yMax) {
                    bumperRightY = yMax;
                }
            }

            // Determines ball behavior based on its position
            function checkBallPosition(xMin, yMin, xMax, yMax, buffer) {
                if (ballY > yMax - buffer || ballY < yMin + buffer) {
                    ballSpeedY *= -1;
                }

                if (ballX < xMin + buffer) {
                    console.log("Hit left edge")
                    if (ballY > bumperLeftY && ballY < bumperLeftY + BUMPER_HEIGHT) {
                        ballSpeedX *= -1;
                        return true;
                    } else {
                        scoreRight += 1;
                        resetBall();
                        return false;
                    }
                }

                if (ballX > xMax - buffer) {
                    console.log("Hit right edge")
                    if (ballY > bumperRightY && ballY < bumperRightY + BUMPER_HEIGHT) {
                        ballSpeedX *= -1;
                        return true;
                    } else {
                        scoreLeft += 1;
                        resetBall();
                        return false;
                    }
                }
            }

            // Draws filled rectangles
            function colorRect(topLeftX, topLeftY, boxWidth, boxHeight, fillColor) {
                canvasContext.fillStyle = fillColor;
                canvasContext.fillRect(topLeftX, topLeftY, boxWidth, boxHeight)
            }

            // Draws filled circles
            function colorCircle(centerX, centerY, radius, fillColor) {
                canvasContext.fillStyle = fillColor;
                canvasContext.beginPath();
                canvasContext.arc(centerX, centerY, radius, 0, 2*Math.PI, true);
                canvasContext.fill();
            }

            // Draws dashed lines
            function dashedLine(startX, startY, endX, endY, lineWidth, linePixels, gapPixels, fillColor) {
                canvasContext.setLineDash([linePixels, gapPixels]);
                canvasContext.lineWidth = lineWidth;
                canvasContext.strokeStyle = fillColor;

                canvasContext.beginPath();
                canvasContext.moveTo(startX, startY);
                canvasContext.lineTo(endX, endY);
                canvasContext.stroke();
            }

            // Calculates actors' positions
            function moveEverything() {
                checkBumperPosition(0, canvas.height - BUMPER_HEIGHT);

                if (checkBallPosition(0, 0, canvas.width, canvas.height, BALL_RADIUS)) {
                    if (Math.abs(ballSpeedX) == INITIAL_BALL_SPEED_X) {ballSpeedX = NORMAL_BALL_SPEED_X * ballSpeedX / Math.abs(ballSpeedX)}
                    if (Math.abs(ballSpeedY) == INITIAL_BALL_SPEED_Y) {ballSpeedY = NORMAL_BALL_SPEED_Y * ballSpeedY / Math.abs(ballSpeedY)}
                }

                ballX += ballSpeedX;
                ballY += ballSpeedY;
            }

            // Draws game actors in the canvas
            function drawEverything() {
                // Fill background with black
                colorRect(0, 0, canvas.width, canvas.height, "black");

                // Draw the ball
                colorCircle(ballX, ballY, BALL_RADIUS, "white")

                // Draw the left bumper
                colorRect(bumperLeftX, bumperLeftY, BUMPER_WIDTH, BUMPER_HEIGHT, "white");

                // Draw the right bumper
                colorRect(bumperRightX, bumperRightY, BUMPER_WIDTH, BUMPER_HEIGHT, "white");

                // Draw the center line
                dashedLine(0.5 * canvas.width, 0, 0.5 * canvas.width, canvas.height, CENTER_LINE_WIDTH, 0.1 * canvas.height, 0.05 * canvas.height, "white");
            }
        </script>
    </body>
</html>